<!DOCTYPE html>
<html>
<head>
  <title>ES Mod Injector</title>
  <style>
    body {
      background: #ffffff;
      color: #000000;
      font-family: system-ui, sans-serif;
      text-align: center;
      padding-top: 60px;
    }

    h1 { font-size: 36px; }

    select {
      padding: 10px;
      font-size: 16px;
      margin: 15px;
    }

    a.button {
      display: inline-block;
      padding: 14px 28px;
      margin: 10px;
      border: 2px solid #000;
      color: #000;
      text-decoration: none;
      font-size: 18px;
      cursor: pointer;
    }

    a.button:hover {
      background: #000;
      color: #fff;
    }

    .footer { margin-top: 40px; }
  </style>
</head>
<body>

<h1>ES Mod Injector</h1>
<p>Select a menu, then drag the inject button to your bookmarks bar.</p>

<select id="menu" onchange="update()">
  <option value="https://cdn.jsdelivr.net/gh/EEEE842/esmodinjector@main/re.sb3">test e MENU</option>
  <option value="https://cdn.jsdelivr.net/gh/EEEE842/esmodinjector@main/dev.sb3">placeholder1</option>
  <option value="https://cdn.jsdelivr.net/gh/EEEE842/esmodinjector@main/rd.sb3">placeholder2</option>
</select>

<br>

<a id="inject" class="button">Inject Menu</a>

<div class="footer">
  <a id="download" class="button" download>Download SB3</a>
</div>

<script>
function update() {
  const sb3 = document.getElementById("menu").value;

  const bookmarklet =
    "javascript:(function(){"+

    // ---------- FIND VM ----------
    "function findVM(){"+

      // ===== 1) SCRATCH =====
      "try{"+
        "if(location.hostname.includes('scratch.mit.edu')){"+
          "const app=document.getElementById('app');"+
          "if(app){"+
            "const key=Object.keys(app).find(k=>k.startsWith('__reactContainer'));"+
            "if(key){"+
              "const fiber=app[key];"+
              "const store=fiber.child?.memoizedProps?.store;"+
              "if(store) return store.getState().scratchGui.vm;"+
            "}"+
            "if(app._reactRootContainer){"+
              "const store=app._reactRootContainer._internalRoot.current.child.pendingProps.store;"+
              "if(store) return store.getState().scratchGui.vm;"+
            "}"+
          "}"+
        "}"+
      "}catch(e){}"+

      // ===== 2) TURBOWARP DIRECT =====
      "if(window.vm) return window.vm;"+
      "if(window.__TW_VM__) return window.__TW_VM__;"+

      // ===== 3) TURBOWARP IFRAME =====
      "let frames=document.getElementsByTagName('iframe');"+
      "for(let i=0;i<frames.length;i++){"+
        "try{"+
          "let w=frames[i].contentWindow;"+
          "if(!w) continue;"+
          "if(w.vm) return w.vm;"+
          "if(w.__TW_VM__) return w.__TW_VM__;"+
        "}catch(e){}"+
      "}"+

      "return null;"+
    "}"+

    // ---------- INJECT ----------
    "function inject(vm){"+
      "window.ES_SELECTED_SB3='"+ sb3 +"';"+
      "var s=document.createElement('script');"+
      "s.src='https://cdn.jsdelivr.net/gh/EEEE842/esmodinjector@main/injector.js';"+
      "document.body.appendChild(s);"+
    "}"+

    "var vm=findVM();"+
    "if(!vm){alert('Scratch/TurboWarp VM not found');return;}"+
    "inject(vm);"+

    "})();";

  document.getElementById("inject").href = bookmarklet;
  document.getElementById("download").href = sb3;
}


update();
</script>

</body>
</html>
